<h1 id="profiling">
  <a aria-hidden="true" class="anchor-heading" href="#profiling"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Profiling
</h1>
<h2 id="motivation">
  <a aria-hidden="true" class="anchor-heading" href="#motivation"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Motivation
</h2>
<p>
  We are planning to add new features to our application, will be good to have a
  "picture" for our api that can show how is the performance of our application
  today. A good advantage is to identify if future changes are affecting the
  current state of our application.
</p>
<h2 id="some-apms-application-performance-management">
  <a
    aria-hidden="true"
    class="anchor-heading"
    href="#some-apms-application-performance-management"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Some APM's (Application Performance Management)
</h2>
<ul>
  <li>new relic</li>
  <li>nsolid</li>
  <li>datadog</li>
  <li>sentry</li>
  <li>raygun</li>
  <li>scout</li>
</ul>
<h2 id="some-standard-profilers">
  <a aria-hidden="true" class="anchor-heading" href="#some-standard-profilers"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Some Standard Profilers
</h2>
<ul>
  <li>v8-profiler</li>
</ul>
<h2 id="other-visualization-profiling-tools">
  <a
    aria-hidden="true"
    class="anchor-heading"
    href="#other-visualization-profiling-tools"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Other visualization profiling tools
</h2>
<p>Clinic-js</p>
<ul>
  <li>Flame</li>
  <li>bubleprof</li>
  <li>doctor mem cpu</li>
</ul>
<h2 id="new-relic">
  <a aria-hidden="true" class="anchor-heading" href="#new-relic"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >New Relic
</h2>
<h3 id="considerations">
  <a aria-hidden="true" class="anchor-heading" href="#considerations"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Considerations
</h3>
<p>Only use versions supported LTS node</p>
<p>Node.js version Comments 6 - 10 Fully supported</p>
<p>11, 12 Not yet fully supported. See related GitHub documentation.</p>
<p>
  There are some frameworks available like express and restify that are
  supported.
</p>
<h3 id="installation">
  <a aria-hidden="true" class="anchor-heading" href="#installation"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Installation
</h3>
<p>
  Is really straigh fordward
  <a
    href="https://docs.newrelic.com/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent"
    >https://docs.newrelic.com/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent</a
  >
</p>
<h3 id="using-autocannon">
  <a aria-hidden="true" class="anchor-heading" href="#using-autocannon"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Using Autocannon
</h3>
<p>npm i autocannon -g</p>
<p>sample:</p>
<pre
  class="language-bash"
><code class="language-bash">autocannon -c <span class="token number">5</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">100</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test
</code></pre>
<h3 id="test-1">
  <a aria-hidden="true" class="anchor-heading" href="#test-1"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Test 1
</h3>
<pre class="language-bash"><code class="language-bash">
Stat <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% <span class="token number">99</span>% Avg Stdev Max
Latency <span class="token number">14389</span> ms <span class="token number">17731</span> ms <span class="token number">33232</span> ms <span class="token number">33232</span> ms <span class="token number">19551.2</span> ms <span class="token number">4577.49</span> ms <span class="token number">33232.82</span> ms

Stat <span class="token number">1</span>% <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% Avg Stdev Min
Req/Sec <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0.19</span> <span class="token number">0.4</span> <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B <span class="token number">0</span> B <span class="token number">319</span> B <span class="token number">60.6</span> B <span class="token number">125</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">30</span> requests <span class="token keyword">in</span> <span class="token number">158</span>.62s, <span class="token number">9.57</span> kB <span class="token builtin class-name">read</span>
<span class="token number">70</span> errors <span class="token punctuation">(</span><span class="token number">0</span> timeouts<span class="token punctuation">)</span>
</code></pre>
<p>and also reduce the parallel work from 5 concurrent connections to 4.</p>
<p>
  We had an anormaly using it, and the application shut down informing that we
  reach a heap size limit.
</p>
<p>
  <img src=".wiki/assets/images/2019-07-01-19-41-49.png" alt="first error" />
</p>
<p>We check on new relic</p>
<p><img src=".wiki/assets/images/2019-07-01-19-42-46.png" alt="ram" /></p>
<p><img src=".wiki/assets/images/2019-07-01-19-43-07.png" alt="cpu" /></p>
<p>We found the problem that was draining memory ram.</p>
<p>
  <a
    href="https://git.autodesk.com/LYNX/hfdm-rest-api/blob/master/src/managers/HfdmManager.js#L161"
    >https://git.autodesk.com/LYNX/hfdm-rest-api/blob/master/src/managers/HfdmManager.js#L161</a
  >
</p>
<p>The test seems to be working as expected.</p>
<p>
  <img src=".wiki/assets/images/2019-07-01-19-54-13.png" alt="ram" />
  <img src=".wiki/assets/images/2019-07-01-19-54-25.png" alt="cpu" />
</p>
<h2 id="conclusions">
  <a aria-hidden="true" class="anchor-heading" href="#conclusions"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Conclusions
</h2>
<p>
  Having an APM to give us feedback about our aplication, is really helpfull and
  almost necesary because it can show us wether the cpu, ram or the response
  time are increasing. Also what feature caused that and make desicions based on
  this information.
</p>
<h2 id="profiling-with-clinicjs">
  <a aria-hidden="true" class="anchor-heading" href="#profiling-with-clinicjs"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Profiling with ClinicJS
</h2>
<h3 id="flame">
  <a aria-hidden="true" class="anchor-heading" href="#flame"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Flame
</h3>
<ul>
  <li>
    The function on the bottom is the function on-CPU. The higher up the y-axis,
    the further nested the function.
  </li>
  <li>
    The width of each function on the graph represents the amount of time it
    took that function to execute as a percentage of the total time of its
    parent function.
  </li>
  <li>
    Finding functions that are both high on the y-axis (deeply nested) and wide
    on the x-axis (time-intensive) is a great way to narrow down performance and
    optimization issues
  </li>
</ul>
<pre
  class="language-bash"
><code class="language-bash">Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%    <span class="token number">99</span>%      Avg        Stdev     Max
Latency <span class="token number">4323</span> ms <span class="token number">5711</span> ms <span class="token number">10033</span> ms <span class="token number">10033</span> ms <span class="token number">5978.53</span> ms <span class="token number">1402.1</span> ms <span class="token number">10033.16</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>%   <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">1</span>     <span class="token number">1</span>     <span class="token number">0.57</span>  <span class="token number">0.53</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">319</span> B <span class="token number">319</span> B <span class="token number">179</span> B <span class="token number">168</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">36</span> requests <span class="token keyword">in</span> <span class="token number">214</span>.65s, <span class="token number">11.5</span> kB <span class="token builtin class-name">read</span>
<span class="token number">4</span> errors <span class="token punctuation">(</span><span class="token number">4</span> timeouts<span class="token punctuation">)</span>
</code></pre>
<h4 id="conclusion">
  <a aria-hidden="true" class="anchor-heading" href="#conclusion"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Conclusion
</h4>
<p>
  We can visualize CPU consumption and know is there is blocking code to take
  action about it.
</p>
<h3 id="doctor">
  <a aria-hidden="true" class="anchor-heading" href="#doctor"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >Doctor
</h3>
<pre
  class="language-bash"
><code class="language-bash">autocannon -c <span class="token number">4</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">40</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test

Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%   <span class="token number">99</span>%     Avg        Stdev     Max
Latency <span class="token number">4808</span> ms <span class="token number">5793</span> ms <span class="token number">7698</span> ms <span class="token number">8119</span> ms <span class="token number">5974.95</span> ms <span class="token number">753.55</span> ms <span class="token number">8119.16</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>%   <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">1</span>     <span class="token number">2</span>     <span class="token number">0.65</span>  <span class="token number">0.65</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">319</span> B <span class="token number">638</span> B <span class="token number">206</span> B <span class="token number">207</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">40</span> requests <span class="token keyword">in</span> <span class="token number">62</span>.19s, <span class="token number">12.8</span> kB <span class="token builtin class-name">read</span>
</code></pre>
<h2 id="bubbleproof">
  <a aria-hidden="true" class="anchor-heading" href="#bubbleproof"
    ><svg aria-hidden="true" viewBox="0 0 16 16">
      <use xlink:href="#svg-link"></use></svg></a
  >bubbleproof
</h2>
<pre class="language-bash"><code class="language-bash">
Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%    <span class="token number">99</span>%      Avg         Stdev      Max
Latency <span class="token number">8586</span> ms <span class="token number">9699</span> ms <span class="token number">14819</span> ms <span class="token number">15510</span> ms <span class="token number">10453.68</span> ms <span class="token number">1595.08</span> ms <span class="token number">15510.06</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">0</span>   <span class="token number">1</span>     <span class="token number">0.38</span>  <span class="token number">0.53</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">0</span> B <span class="token number">319</span> B <span class="token number">120</span> B <span class="token number">167</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">40</span> requests <span class="token keyword">in</span> <span class="token number">106</span>.14s, <span class="token number">12.8</span> kB <span class="token builtin class-name">read</span>

autocannon -c <span class="token number">4</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">40</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test
</code></pre>
